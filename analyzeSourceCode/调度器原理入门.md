# 调度器设计原理

因为在布隆过滤器部分，涉及了两层调度器，把笔者看晕了，于是来补调度器设计原理，大内容来自其他博客，如果感兴趣可以看最后的原文链接。

## 一、调度器的定义

无论是在单机系统还是分布式系统当中，调度器其实都是非常核心和普遍的组件，其内涵比较宽广，也比较模糊,很多领域都会使用调度这个术语，在计算机科学中，调度就是一种将任务（Work）分配给资源的方法[1](https://draveness.me/system-design-scheduler/#fn:1)。

一般来说，下面提到的几种类型的模块都可以认为是调度器：

- 早期计算机系统当中的批处理调度系统；
- 现代计算机系统当中的抢占式进程调度系统和内存分配系统；
- 某些系统或程序提供或实现的，定时激发某些类型操作的工具（如 crontab、Quartz 等）；
- 某些编程语言的 Runtime 提供的线程/纤程/协程调度器（如 Golang 内置的 Goroutine 调度器）；
- 分布式系统当中的任务关系管理和调度执行系统，（如 Hadoop YARN， Airflow 等）；
- 分布式系统当中的资源管理和调度系统（如 Mesos、Borg、Kubernetes 的调度器等）。

可以被称为调度器的工具涵盖范围非常广，他们有的提供定时激发任务的能力，有的提供资源管理的能力，有的负责维护任务的依赖关系和执行顺序，甚至有的系统还集成了任务监控和各种指标度量的工具。 

## 二、调度器设计概述

我们的系统设计——无论是小到一个嵌入式的系统，还是大到好几百个机器的集群——在设计抽象上都是在不同的层次上重复自己。

比如说：

- 如果我们着眼于一个 CPU，它包括计算单元和一系列用来加速数据访问的缓存 L1、L2、L3 等，每种缓存具有不同的访问速度；
- 当我们的视野扩大到整个机器，CPU 又可以被当成一个单元，我们又有内存和硬盘两个层次的储存系统用于加速数据载入；
- 而在分布式系统中，如果我们把 HDFS 或 S3 看作硬盘，也存在像 Alluxio 这样发挥着类似内存作用的系统。

## 三、分布式调度器的分类

### 1、集中式调度器

集中式（Centralized）调度器也可以被称为宏（Monolithic）调度器，指的是使用中心化的方式管理资源和调度任务。也就是说，调度器本身在系统中只存在单个实例，所有的资源请求和任务调度都通过这一个实例进行。

![img](https://static001.infoq.cn/resource/image/0d/14/0d9e7839510cfa66601650192f7b3814.png)

集中式调度器在各个方面的表现状况：

- 适合批处理任务和吞吐量较大、运行时间较长的任务；
- 调度算法只能全部内置在核心调度器当中，灵活性和策略的可扩展性不高；
- 状态同步比较容易且稳定，这是因为资源使用和任务执行的状态被统一管理，降低了状态同步和并发控制的难度；
- 由于存在单点故障的可能性，集中式调度器的容错性一般，有些系统通过热备份 Master 的方式提高可用性；
- 由于所有的资源和任务请求都要由中央调度器处理，集中式调度器的可扩展性较差，容易成为分布式系统吞吐量的瓶颈；
- 尽管应用场合比较局限，集中式调度器仍然是普遍使用的调度器，可广泛应用于中小规模数据平台应用。

### 2、双层调度器

前面提到，集中式调度器的主要缺点在于单点模型容错性和可扩展性较差，容易成为性能瓶颈。在一般的数据密集型应用当中，解决这一问题的主要方法是分区。下图是双层调度器的一般模型：

![img](https://static001.infoq.cn/resource/image/22/f0/22e3de6acb734948fbb30e90ab1e01f0.png)

在双层调度器当中，资源的使用状态同时由分区调度器和中央调度器管理，但是中央调度器一般只负责宏观的、大规模的资源分配，业务压力较小。

分区调度器负责管理自己分区的所有资源和任务，一般只有当所在分区资源无法满足需求时，才将任务冒泡到中央调度器处理。

相比集中式调度器，双层调度器某一分区内的资源分配和工作安排可以由具体的任务本身进行定制，因此大大增强了使用的灵活性，可以同时对高吞吐和低延迟的两种场景提供良好的支持。

每个分区可以独立运行，降低了单点故障导致系统崩溃的概率，增加了可用性和可扩展性。但是反过来也导致状态同步和维护变得比较困难。

### 3、共享状态调度器

通过前面两种模型的介绍，可以发现集群中需要管理的状态主要包括以下两种：

- 系统中资源分配和使用的状态
- 系统中任务调度和执行的状态

在集中式调度器里，这两个状态都由中心调度器管理，并且一并集成了调度等功能；双层调度器模式里，这两个状态分别由中央调度器和次级调度器管理。

集中式调度器可以容易地保证全局状态的一致性，但是可扩展性不够；双层调度器对共享状态的管理较难达到好的一致性保证，也不容易检测资源竞争和死锁。

为了解决这些问题，一种新的调度器架构被设计出来。这种架构基本上沿袭了集中式调度器的模式，通过将中央调度器肢解为多个服务以提供更好的伸缩性。这种调度器的核心是共享的集群状态，因此可以被称为共享状态调度器。

![img](https://static001.infoq.cn/resource/image/d0/38/d06982bb2009aac4fc0a72fd7f62fc38.png)





## 参考

- [7 种主流案例，告诉你调度器架构设计通用法则（上）](https://www.infoq.cn/article/dbi9u94s7msejugreimp)
- [调度系统设计精要](https://draveness.me/system-design-scheduler/)

